<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Visualizar Datos - EcoEnergy</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">
    <aside class="sidebar">
        <h1 class="logo">游눦 EcoEnergy</h1>
        <nav class="nav">
            <span class="section">NAVEGACI칍N</span>
            <a href="index.html">Inicio</a>
            <a href="hidroelectrica.html">Energ칤a Hidroel칠ctrica</a>
            <a href="datos.html" class="active">Visualizar Datos</a>
            <a href="calculadora.html">Calculadora</a>
            <a href="dashboard.html">Dashboard Visual</a>
        </nav>
    </aside>

    <main class="main">
        <h3>Cargar Datos CSV</h3>
        <p>Carga el archivo CSV con la participaci칩n de energ칤as renovables para analizar los datos.</p>
        
        <div class="card p-4">
            <div class="mb-3">
                <label for="fileInput" class="form-label">Archivo de Participaci칩n de Energ칤as Renovables:</label>
                <input class="form-control" type="file" id="fileInput" accept=".csv">
            </div>
            <button id="loadButton" class="btn btn-primary">Cargar y Guardar Datos</button>
        </div>

        <div id="status" class="mt-3"></div>

        <div id="visualizations-container" class="card p-4">
            
            <div class="card p-4">
                <div class="chart-card large-chart-card">
                    <h4>M칠trica Global: Participaci칩n de Renovables por Pa칤s y A침o</h4>
                    <p class="text-muted">El color indica el porcentaje de participaci칩n (m치s oscuro = mayor %)</p>
                    <div id="heatmap-container" class="heatmap-box">
                        </div>
                </div>
            </div>

            <hr class="my-5">

            <div class="dashboard-filters">
                <div class="filter-group">
                    <label for="countryFilter" class="form-label">Filtrar por Pa칤s:</label>
                    <select id="countryFilter" class="form-control"></select>
                </div>
                <div class="filter-group">
                    <label for="yearFilter" class="form-label">Filtrar por A침o:</label>
                    <select id="yearFilter" class="form-control"></select>
                </div>
            </div>
            
            <div id="chartInfoMessage" class="alert alert-info d-none">
                No hay datos disponibles para la combinaci칩n de pa칤s y a침o seleccionada.
            </div>

            <div class="dashboard-grid full-width">
                <div class="chart-card large-chart-card">
                    <h4>Evoluci칩n de la Participaci칩n de Energ칤as Renovables</h4>
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
            
            <hr class="my-5">
            
            <div class="dashboard-grid">
                <div class="chart-card">
                    <h4>Comparaci칩n de la Participaci칩n Renovable (A침o Seleccionado)</h4>
                    <canvas id="shareBarChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4>Distribuci칩n de la Participaci칩n Energ칠tica</h4>
                    <canvas id="sharePieChart"></canvas>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let renewableData = [];
    let shareHeader = '';
    const localStorageKey = 'renovable';

    document.addEventListener('DOMContentLoaded', () => {
        const renewableShare = localStorage.getItem(localStorageKey);
        if (renewableShare) {
            try {
                renewableData = JSON.parse(renewableShare);
                if (renewableData.length > 0) {
                    const headers = Object.keys(renewableData[0]);
                    shareHeader = headers.find(h => h.includes('Renewables (% equivalent primary energy)'));
                    if (shareHeader) {
                        document.getElementById('visualizations-container').classList.remove('d-none');
                        renderGlobalHeatmap();
                        populateFilters();
                    }
                }
            } catch (e) {
                console.error("Error al parsear los datos de localStorage:", e);
                renewableData = [];
            }
        }
    });

    document.getElementById('loadButton').addEventListener('click', () => {
        const file = document.getElementById('fileInput').files[0];
        const statusDiv = document.getElementById('status');

        if (file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const data = results.data.filter(row => row.Entity && row.Year);
                    localStorage.setItem(localStorageKey, JSON.stringify(data));
                    
                    renewableData = data;
                    if (renewableData.length > 0) {
                        const headers = Object.keys(renewableData[0]);
                        shareHeader = headers.find(h => h.includes('Renewables (% equivalent primary energy)'));
                    }

                    if (shareHeader) {
                        statusDiv.innerHTML = `<div class="alert alert-success">Archivo "${file.name}" cargado y guardado correctamente.</div>`;
                        document.getElementById('visualizations-container').classList.remove('d-none');
                        renderGlobalHeatmap();
                        populateFilters();
                    } else {
                        statusDiv.innerHTML = `<div class="alert alert-danger">Error: No se encontr칩 la columna de participaci칩n de energ칤as renovables.</div>`;
                        document.getElementById('visualizations-container').classList.add('d-none');
                    }
                },
                error: function(err) {
                    statusDiv.innerHTML = `<div class="alert alert-danger">Error al parsear el archivo: ${err.message}</div>`;
                }
            });
        } else {
            statusDiv.innerHTML = `<div class="alert alert-warning">Por favor, selecciona un archivo.</div>`;
        }
    });

    function populateFilters() {
        const countryFilter = document.getElementById('countryFilter');
        const yearFilter = document.getElementById('yearFilter');
        
        const validEntries = renewableData.filter(d => d[shareHeader] !== null);
        
        const countries = [...new Set(validEntries.map(row => row['Entity']))].sort();
        const years = [...new Set(validEntries.map(row => row['Year']))].sort((a, b) => b - a);
        
        countryFilter.innerHTML = '<option value="">Seleccione un pa칤s</option>' + countries.map(c => `<option value="${c}">${c}</option>`).join('');
        yearFilter.innerHTML = '<option value="">Seleccione un a침o</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');

        countryFilter.addEventListener('change', renderCharts);
        yearFilter.addEventListener('change', renderCharts);
        
        renderCharts();
    }
    
    function renderGlobalHeatmap() {
        const heatmapContainer = document.getElementById('heatmap-container');
        const validEntries = renewableData.filter(d => d[shareHeader] !== null && d.Entity && d.Year);
        
        const countries = [...new Set(validEntries.map(row => row.Entity))].sort();
        const years = [...new Set(validEntries.map(row => row.Year))].sort((a, b) => a - b);
        
        let html = '<table class="heatmap-table">';
        
        html += '<thead><tr><th class="country-header corner-cell">Pa칤s</th>';
        years.forEach(year => {
            html += `<th class="year-header">${year}</th>`;
        });
        html += '</tr></thead>';

        html += '<tbody>';
        countries.forEach(country => {
            html += `<tr><td class="country-label">${country}</td>`;
            years.forEach(year => {
                const rowData = validEntries.find(d => d.Entity === country && d.Year === year);
                const value = rowData ? parseFloat(rowData[shareHeader]) : null;
                const color = getColor(value);
                const title = value !== null ? `${country} (${year}): ${value.toFixed(2)}%` : 'Sin datos';
                html += `<td class="data-cell" style="background-color: ${color}" title="${title}"></td>`;
            });
            html += '</tr>';
        });
        html += '</tbody>';
        html += '</table>';
        
        heatmapContainer.innerHTML = html;
    }

    function getColor(d) {
        return d > 90 ? '#005a32' :
               d > 80 ? '#238443' :
               d > 70 ? '#41ab5d' :
               d > 60 ? '#78c679' :
               d > 50 ? '#addd8e' :
               d > 40 ? '#d9f0a3' :
               d > 30 ? '#fecc5c' :
               d > 20 ? '#fd8d3c' :
               d > 10 ? '#f03b20' :
               d > 0  ? '#bd0026' :
                        '#e0e0e0';
    }
    
    function renderCharts() {
        const selectedCountry = document.getElementById('countryFilter').value;
        const selectedYear = document.getElementById('yearFilter').value;
        const chartInfoMessage = document.getElementById('chartInfoMessage');

        if (window.charts) {
            Object.values(window.charts).forEach(chart => chart.destroy());
        }
        window.charts = {};

        if (selectedCountry) {
            renderEvolutionChart(selectedCountry);
        } else {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        }

        if (selectedCountry && selectedYear) {
            const shareRow = renewableData.find(d => d.Entity === selectedCountry && d.Year == selectedYear);
            if (!shareRow || shareRow[shareHeader] === null) {
                chartInfoMessage.textContent = `No hay datos para la combinaci칩n de pa칤s "${selectedCountry}" y a침o "${selectedYear}".`;
                chartInfoMessage.classList.remove('d-none');
            } else {
                chartInfoMessage.classList.add('d-none');
                renderShareBarChart(shareRow, selectedCountry, selectedYear);
                renderSharePieChart(shareRow, selectedCountry, selectedYear);
            }
        } else {
            chartInfoMessage.textContent = `Por favor, seleccione un pa칤s y un a침o para ver los gr치ficos comparativos.`;
            chartInfoMessage.classList.remove('d-none');
        }
    }
    
    function renderEvolutionChart(selectedCountry) {
        const countryData = renewableData.filter(d => d.Entity === selectedCountry && d[shareHeader] !== null);
        const years = countryData.map(d => d.Year);
        const values = countryData.map(d => parseFloat(d[shareHeader]));

        const ctx = document.getElementById('evolutionChart').getContext('2d');
        window.charts.chart1 = new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [{
                    label: `Participaci칩n de Renovables en ${selectedCountry} (%)`,
                    data: values,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: false,
                    tension: 0.4,
                    spanGaps: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Participaci칩n (%)' }
                    }
                }
            }
        });
    }

    function renderShareBarChart(shareRow, selectedCountry, selectedYear) {
        const shareValor = parseFloat(shareRow[shareHeader]) || 0;
        const worldData = renewableData.find(d => d.Entity === 'World' && d.Year == selectedYear);
        const worldShare = worldData ? (parseFloat(worldData[shareHeader]) || 0) : 0;
        
        const ctx = document.getElementById('shareBarChart').getContext('2d');
        window.charts.chart2 = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [selectedCountry, 'Mundo'],
                datasets: [{
                    label: `Participaci칩n Renovable en ${selectedYear}`,
                    data: [shareValor, worldShare],
                    backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)'],
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Participaci칩n (%)' } } }
            }
        });
    }
    
    function renderSharePieChart(shareRow) {
        const shareValor = parseFloat(shareRow[shareHeader]) || 0;
        const otherEnergy = Math.max(0, 100 - shareValor);
        
        const ctx = document.getElementById('sharePieChart').getContext('2d');
        window.charts.chart3 = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Energ칤a Renovable', 'Otras Fuentes'],
                datasets: [{
                    data: [shareValor, otherEnergy],
                    backgroundColor: ['rgba(75, 192, 192, 0.7)', 'rgba(201, 203, 207, 0.7)'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                return `${label}: ${value.toFixed(2)}%`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>

<style>
/* Estilos para el mapa de calor */
/* --- Estilos para el Mapa de Calor --- */

/* * Contenedor principal que permite el scroll horizontal y vertical si la tabla es m치s grande.
 * Es crucial que este contenedor tenga un ancho del 100% y maneje el desbordamiento.
 */
.heatmap-box {
    height: 400px;
    width: 100%;
    overflow: auto;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin-top: 20px;
}

/* * La tabla del mapa de calor en s칤.
 * La clave para la responsividad es ELIMINAR el "min-width: 768px;" que causa el desbordamiento.
 * Ahora la tabla se adaptar치 al ancho del contenedor.
 */
.heatmap-table {
    width: auto; /* Se ajusta autom치ticamente al contenido */
    border-collapse: collapse;
    font-size: 10px;
    position: relative;
    /* Las siguientes l칤neas causaban el problema de desbordamiento, por eso se deben eliminar o comentar: */
    /* min-width: 768px; */ 
    /* min-height: 768px; */
}

/* Estilos de las celdas y encabezados (se mantienen para la apariencia y usabilidad) */
.heatmap-table th, .heatmap-table td {
    border: 1px solid #ddd;
    text-align: center;
    padding: 2px;
    white-space: nowrap; /* Evita que el texto de las celdas salte de l칤nea */
}
.heatmap-table thead th {
    background-color: #f2f2f2;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
}
.heatmap-table .country-header {
    text-align: left;
    background-color: #f8f8f8;
    font-weight: 500;
    min-width: 100px;
}
.heatmap-table .year-header {
    min-width: 40px;
}
.heatmap-table .data-cell {
    /* El ancho de la celda es fijo, pero la tabla se desplaza si es muy grande */
    width: 40px;
    height: 20px;
}

/* Columna de pa칤ses fija (sticky) para facilitar la navegaci칩n */
.heatmap-table .country-label {
    text-align: left;
    background-color: #f8f8f8;
    font-weight: 500;
    min-width: 100px;
    position: sticky;
    left: 0;
    z-index: 9;
}

/* Celda de la esquina superior izquierda (Pa칤s/A침o) fija */
.heatmap-table .corner-cell {
    position: sticky;
    top: 0;
    left: 0;
    z-index: 11;
    background-color: #f2f2f2;
}

</style>

</body>
</html>