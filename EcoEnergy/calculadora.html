<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Calculadora EcoEnergy</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<button class="menu-toggle" aria-label="Abrir men√∫">‚ò∞</button>
<div class="container">
    <aside class="sidebar">
        <h1 class="logo">üíß EcoEnergy</h1>
        <nav class="nav">
            <span class="section">NAVEGACI√ìN</span>
            <a href="index.html">Inicio</a>
            <a href="hidroelectrica.html">Energ√≠a Hidroel√©ctrica</a>
            <a href="datos.html">Visualizar Datos</a>
            <a href="calculadora.html" class="active">Calculadora</a>
            <a href="dashboard.html">Dashboard Visual</a>
        </nav>
    </aside>

    <main class="main">
        <h3>Calculadora de Consumo Renovable</h3>
        <p>Realiza una estimaci√≥n detallada del porcentaje de energ√≠a renovable en tu consumo el√©ctrico total, basada en el mix energ√©tico de una regi√≥n o pa√≠s.</p>

        <div id="loading" class="alert alert-info">Cargando archivos de datos desde la carpeta local...</div>
        <div id="noDataMessage" class="alert alert-danger d-none">
            <p><strong>Error:</strong> No se pudieron cargar los archivos de datos necesarios. Aseg√∫rate de que los archivos CSV est√°n en la misma carpeta.</p>
        </div>

        <div id="calculator-content" class="d-none">
            <div class="form-group mb-3">
                <label for="countrySelect" class="form-label">Selecciona una regi√≥n o pa√≠s para el c√°lculo:</label>
                <select id="countrySelect" class="form-control"></select>
            </div>
            
            <div class="form-group mb-3">
                <label for="yearSelect" class="form-label">Selecciona un a√±o:</label>
                <select id="yearSelect" class="form-control"></select>
            </div>

            <div class="form-group mb-3">
                <label for="consumptionInput" class="form-label">Ingresa tu consumo el√©ctrico total (kWh) anual:</label>
                <input type="number" id="consumptionInput" class="form-control" placeholder="Ej: 3600" required>
            </div>
            
            <button id="calculateBtn" class="btn btn-primary">Calcular</button>

            <div id="results" class="results-card mt-4 d-none">
                <h4 class="mb-3">An√°lisis de la Regi√≥n y Proyecci√≥n Personal</h4>
                <div id="countryAnalysis"></div>
                <hr>
                <div id="personalProjection"></div>
                <div class="alert alert-info mt-3">
                    <p class="mb-0"><strong>Aclaraci√≥n:</strong> Este c√°lculo es una estimaci√≥n hipot√©tica. El porcentaje real de energ√≠a renovable en tu consumo depende del mix energ√©tico de tu proveedor local y de tu plan de electricidad.</p>
                </div>
            </div>
        </div>
    </main>
    
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
    const dataFiles = [
        { key: 'prod', url: '03 modern-renewable-prod.csv' },
        { key: 'shareRenewables', url: '04 share-electricity-renewables.csv' },
        { key: 'windCapacity', url: '09 cumulative-installed-wind-energy-capacity-gigawatts.csv' },
    ];

    let allData = {};
    
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
    });

    function loadData() {
        const promises = dataFiles.map(file => {
            return new Promise((resolve, reject) => {
                Papa.parse(file.url, {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        allData[file.key] = results.data;
                        resolve();
                    },
                    error: (error) => {
                        reject(error);
                    }
                });
            });
        });

        Promise.all(promises)
            .then(() => {
                document.getElementById('loading').classList.add('d-none');
                document.getElementById('calculator-content').classList.remove('d-none');
                populateFilters();
                document.getElementById('calculateBtn').addEventListener('click', calculateRenewableConsumption);
            })
            .catch(error => {
                console.error("Error loading data files:", error);
                document.getElementById('loading').classList.add('d-none');
                document.getElementById('noDataMessage').classList.remove('d-none');
            });
    }

    function populateFilters() {
        const countrySelect = document.getElementById('countrySelect');
        const yearSelect = document.getElementById('yearSelect');
        
        const countries = [...new Set(allData.prod.map(row => row.Entity))].sort();
        const years = [...new Set(allData.prod.map(row => row.Year))].sort((a, b) => b - a);

        countrySelect.innerHTML = countries.map(c => `<option value="${c}">${c}</option>`).join('');
        yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

        countrySelect.value = 'World';
        yearSelect.value = '2021';
    }

    function calculateRenewableConsumption() {
        const consumptionInput = document.getElementById('consumptionInput');
        const selectedCountry = document.getElementById('countrySelect').value;
        const selectedYear = document.getElementById('yearSelect').value;

        const userConsumption = parseFloat(consumptionInput.value);

        if (isNaN(userConsumption) || userConsumption <= 0) {
            alert('Por favor, ingresa un consumo el√©ctrico v√°lido (un n√∫mero mayor que cero).');
            return;
        }

        const prodRow = allData.prod.find(d => d.Entity === selectedCountry && d.Year == selectedYear);
        const shareRow = allData.shareRenewables.find(d => d.Entity === selectedCountry && d.Year == selectedYear);
        const windCapacityRow = allData.windCapacity.find(d => d.Entity === selectedCountry && d.Year == selectedYear);
        
        if (!prodRow || !shareRow) {
            alert(`No se encontraron datos de producci√≥n para ${selectedCountry} en el a√±o ${selectedYear}.`);
            return;
        }

        // 1. An√°lisis del Mix Energ√©tico de la Regi√≥n
        const totalRenewableProd = (prodRow['Electricity from wind (TWh)'] || 0) +
                                   (prodRow['Electricity from hydro (TWh)'] || 0) +
                                   (prodRow['Electricity from solar (TWh)'] || 0) +
                                   (prodRow['Other renewables including bioenergy (TWh)'] || 0);
        
        const renewableSharePercentage = shareRow['Renewables (% electricity)'];
        const totalProduction = (totalRenewableProd * 100) / renewableSharePercentage;
        const nonRenewableShare = 100 - renewableSharePercentage;

        // Porcentajes de contribuci√≥n de cada fuente renovable
        const windShare = (prodRow['Electricity from wind (TWh)'] / totalProduction) * 100;
        const hydroShare = (prodRow['Electricity from hydro (TWh)'] / totalProduction) * 100;
        const solarShare = (prodRow['Electricity from solar (TWh)'] / totalProduction) * 100;
        const otherShare = (prodRow['Other renewables including bioenergy (TWh)'] / totalProduction) * 100;

        // 2. Proyecci√≥n de Consumo Personal
        const renewableConsumptionKWh = (userConsumption * renewableSharePercentage) / 100;
        const nonRenewableConsumptionKWh = (userConsumption * nonRenewableShare) / 100;

        const resultsDiv = document.getElementById('results');
        const countryAnalysisDiv = document.getElementById('countryAnalysis');
        const personalProjectionDiv = document.getElementById('personalProjection');
        
        // Formatear la salida del an√°lisis del pa√≠s
        countryAnalysisDiv.innerHTML = `
            <p><strong>An√°lisis de la producci√≥n el√©ctrica en ${selectedCountry} en ${selectedYear}:</strong></p>
            <ul>
                <li><strong>Energ√≠a Renovable Total:</strong> ${renewableSharePercentage.toFixed(2)}% del total.</li>
                <li><strong>Energ√≠a No Renovable:</strong> ${nonRenewableShare.toFixed(2)}% del total.</li>
            </ul>
            <p><strong>Contribuci√≥n de cada fuente renovable:</strong></p>
            <ul>
                <li>E√≥lica: ${windShare.toFixed(2)}%</li>
                <li>Hidroel√©ctrica: ${hydroShare.toFixed(2)}%</li>
                <li>Solar: ${solarShare.toFixed(2)}%</li>
                <li>Otras (bioenerg√≠a, etc.): ${otherShare.toFixed(2)}%</li>
            </ul>
            ${windCapacityRow ? `<p><strong>Capacidad de Energ√≠a E√≥lica Instalada:</strong> ${parseFloat(windCapacityRow['Wind Capacity']).toFixed(2)} GW</p>` : ''}
        `;

        // Formatear la salida de la proyecci√≥n personal
        personalProjectionDiv.innerHTML = `
            <p><strong>Proyecci√≥n de tu consumo anual (${userConsumption.toFixed(2)} kWh):</strong></p>
            <ul>
                <li><strong>Consumo estimado de energ√≠a renovable:</strong> ${renewableConsumptionKWh.toFixed(2)} kWh</li>
                <li><strong>Consumo estimado de energ√≠a no renovable:</strong> ${nonRenewableConsumptionKWh.toFixed(2)} kWh</li>
            </ul>
            <p>Con base en el mix energ√©tico de ${selectedCountry} en ${selectedYear}, aproximadamente el <strong>${renewableSharePercentage.toFixed(2)}%</strong> de tu consumo anual ser√≠a de fuentes renovables.</p>
        `;
        
        resultsDiv.classList.remove('d-none');
    }
</script>
<footer class="footer">
    <div class="footer-content">
        <p>&copy; 2025 EcoEnergy - TalentoTech2.0</p>
    </div>
</footer>
<script src="script.js"></script>
</body>
</html>