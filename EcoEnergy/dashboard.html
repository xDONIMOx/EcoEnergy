<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard Visual - EcoEnergy</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">
    <aside class="sidebar">
        <h1 class="logo">游눦 EcoEnergy</h1>
        <nav class="nav">
            <span class="section">NAVEGACI칍N</span>
            <a href="index.html">Inicio</a>
            <a href="hidroelectrica.html">Energ칤a Hidroel칠ctrica</a>
            <a href="datos.html">Visualizar Datos</a>
            <a href="calculadora.html">Calculadora</a>
            <a href="dashboard.html" class="active">Dashboard Visual</a>
        </nav>
    </aside>

    <main class="main">
        <h3>Dashboard de Energ칤as Renovables</h3>
        <p>An치lisis detallado de la producci칩n y consumo de energ칤as renovables utilizando m칰ltiples fuentes de datos.</p>
        
        <div id="loading" class="alert alert-info">Cargando archivos de datos desde la carpeta local...</div>
        <div id="noDataMessage" class="alert alert-danger d-none">
            <p><strong>Error:</strong> No se pudieron cargar todos los archivos de datos necesarios. Aseg칰rate de que los archivos CSV est치n en la misma carpeta.</p>
        </div>

        <div id="dashboard-content" class="d-none">
            <div class="dashboard-filters">
                <div class="filter-group">
                    <label for="countryFilter" class="form-label">Filtrar por Pa칤s:</label>
                    <select id="countryFilter" class="form-control"></select>
                </div>
                <div class="filter-group">
                    <label for="yearFilter" class="form-label">Filtrar por A침o:</label>
                    <select id="yearFilter" class="form-control"></select>
                </div>
            </div>
            
            <div id="chartInfoMessage" class="alert alert-warning d-none">
                Selecciona un pa칤s para ver la tendencia hist칩rica o un a침o para ver la distribuci칩n.
            </div>

            <div class="dashboard-grid">
                <div class="chart-card large-chart-card">
                    <h4>Producci칩n de Energ칤a Renovable por Fuente (TWh)</h4>
                    <p class="text-muted">Muestra la cantidad de energ칤a producida por cada fuente renovable en el a침o seleccionado.</p>
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="chart-card">
                    <h4>Participaci칩n de Energ칤as Renovables (%)</h4>
                    <p class="text-muted">Muestra el porcentaje de cada tipo de energ칤a renovable en el total del consumo el칠ctrico.</p>
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4>Consumo de Energ칤a Renovable Moderna (TWh)</h4>
                    <p class="text-muted">Muestra la evoluci칩n del consumo de energ칤a renovable moderna a lo largo del tiempo.</p>
                    <canvas id="areaChart"></canvas>
                </div>
            </div>
            
            <div class="dashboard-grid full-width">
                <div class="chart-card large-chart-card">
                    <h4>Tendencia en la Producci칩n de Energ칤a (TWh)</h4>
                    <p class="text-muted">Muestra la evoluci칩n de la producci칩n de energ칤a e칩lica, solar e hidroel칠ctrica a lo largo del tiempo.</p>
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const dataFiles = [
        { key: 'prod', url: '03 modern-renewable-prod.csv' },
        { key: 'shareTotal', url: '04 share-electricity-renewables.csv' },
        { key: 'shareHydro', url: '07 share-electricity-hydro.csv' },
        { key: 'consumption', url: '02 modern-renewable-energy-consumption.csv' },
    ];

    let allData = {};
    let charts = {};

    document.addEventListener('DOMContentLoaded', () => {
        loadAllData();
    });

    function loadAllData() {
        const promises = dataFiles.map(file => {
            return new Promise((resolve, reject) => {
                Papa.parse(file.url, {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        allData[file.key] = results.data;
                        resolve();
                    },
                    error: (error) => {
                        reject(error);
                    }
                });
            });
        });

        Promise.all(promises)
            .then(() => {
                document.getElementById('loading').classList.add('d-none');
                document.getElementById('dashboard-content').classList.remove('d-none');
                populateFilters();
                renderCharts(); // Carga los gr치ficos con los valores por defecto
            })
            .catch(error => {
                console.error("Error loading data files:", error);
                document.getElementById('loading').classList.add('d-none');
                document.getElementById('noDataMessage').classList.remove('d-none');
            });
    }

    function populateFilters() {
        const countryFilter = document.getElementById('countryFilter');
        const yearFilter = document.getElementById('yearFilter');
        
        const validEntries = allData.prod.filter(d => d.Entity && d.Year);
        
        const countries = [...new Set(validEntries.map(row => row.Entity))].sort();
        const years = [...new Set(validEntries.map(row => row.Year))].sort((a, b) => b - a);
        
        countryFilter.innerHTML = '<option value="">Seleccione un pa칤s</option>' + countries.map(c => `<option value="${c}">${c}</option>`).join('');
        yearFilter.innerHTML = '<option value="">Seleccione un a침o</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');

        // Establecer valores por defecto
        countryFilter.value = 'World';
        yearFilter.value = '2021';

        countryFilter.addEventListener('change', renderCharts);
        yearFilter.addEventListener('change', renderCharts);
    }
    
    function renderCharts() {
        const selectedCountry = document.getElementById('countryFilter').value;
        const selectedYear = document.getElementById('yearFilter').value;
        const chartInfoMessage = document.getElementById('chartInfoMessage');

        // Destruir gr치ficos anteriores
        if (charts.barChart) charts.barChart.destroy();
        if (charts.pieChart) charts.pieChart.destroy();
        if (charts.lineChart) charts.lineChart.destroy();
        if (charts.areaChart) charts.areaChart.destroy();
        
        // Determinar qu칠 gr치ficos renderizar en funci칩n de la selecci칩n de filtros
        const countryIsSelected = selectedCountry !== '';
        const yearIsSelected = selectedYear !== '';

        if (!countryIsSelected && !yearIsSelected) {
            // No hay filtros seleccionados, se muestra el estado inicial (podr칤a ser un mensaje o un render por defecto si no lo hacemos al inicio)
            chartInfoMessage.textContent = 'Selecciona un pa칤s para ver la tendencia hist칩rica o un a침o para ver la distribuci칩n.';
            chartInfoMessage.classList.remove('d-none');
            return;
        }

        chartInfoMessage.classList.add('d-none');

        // Renderizar los gr치ficos de tendencia si se selecciona un pa칤s
        if (countryIsSelected) {
            renderLineChart(selectedCountry);
            renderAreaChart(selectedCountry);
        }

        // Renderizar los gr치ficos de distribuci칩n si se selecciona un a침o
        if (yearIsSelected) {
            // Si el pa칤s no est치 seleccionado, se usa 'World' para los gr치ficos de distribuci칩n
            const countryForDistribution = countryIsSelected ? selectedCountry : 'World';
            renderBarChart(countryForDistribution, selectedYear);
            renderPieChart(countryForDistribution, selectedYear);
        }
    }
    
    function renderBarChart(country, year) {
        const row = allData.prod.find(d => d.Entity === country && d.Year == year);
        if (!row) return;
        
        const labels = ['E칩lica', 'Hidroel칠ctrica', 'Solar', 'Bioenerg칤a y otras'];
        const data = [
            row['Electricity from wind (TWh)'],
            row['Electricity from hydro (TWh)'],
            row['Electricity from solar (TWh)'],
            row['Other renewables including bioenergy (TWh)']
        ];

        const ctx = document.getElementById('barChart').getContext('2d');
        charts.barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Producci칩n de Energ칤a Renovable en ${year} (TWh)`,
                    data: data,
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ],
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'TWh' }
                    }
                }
            }
        });
    }

    function renderPieChart(country, year) {
        const totalShareRow = allData.shareTotal.find(d => d.Entity === country && d.Year == year);
        const hydroShareRow = allData.shareHydro.find(d => d.Entity === country && d.Year == year);
        
        if (!totalShareRow || !hydroShareRow) return;

        const totalRenewableShare = totalShareRow['Renewables (% electricity)'] || 0;
        const hydroShare = hydroShareRow['Hydro (% electricity)'] || 0;
        const otherRenewableShare = Math.max(0, totalRenewableShare - hydroShare);
        const nonRenewableShare = Math.max(0, 100 - totalRenewableShare);
        
        const labels = ['Hidroel칠ctrica', 'Otras Renovables', 'No Renovables'];
        const data = [hydroShare, otherRenewableShare, nonRenewableShare];

        const ctx = document.getElementById('pieChart').getContext('2d');
        charts.pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(201, 203, 207, 0.7)'
                    ],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                return `${label}: ${value.toFixed(2)}%`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    function renderLineChart(country) {
        const countryData = allData.prod.filter(d => d.Entity === country && d['Electricity from wind (TWh)'] !== null);
        const years = countryData.map(d => d.Year);
        const windValues = countryData.map(d => parseFloat(d['Electricity from wind (TWh)']));
        const solarValues = countryData.map(d => parseFloat(d['Electricity from solar (TWh)']));
        const hydroValues = countryData.map(d => parseFloat(d['Electricity from hydro (TWh)']));

        const ctx = document.getElementById('lineChart').getContext('2d');
        charts.lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [
                    {
                        label: 'Producci칩n E칩lica (TWh)',
                        data: windValues,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false,
                        tension: 0.4,
                    },
                    {
                        label: 'Producci칩n Solar (TWh)',
                        data: solarValues,
                        borderColor: 'rgba(255, 206, 86, 1)',
                        fill: false,
                        tension: 0.4,
                    },
                    {
                        label: 'Producci칩n Hidroel칠ctrica (TWh)',
                        data: hydroValues,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        fill: false,
                        tension: 0.4,
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'TWh' }
                    }
                }
            }
        });
    }

    function renderAreaChart(country) {
        const countryData = allData.consumption.filter(d => d.Entity === country);
        const years = countryData.map(d => d.Year);
        const renewableConsumption = countryData.map(d => 
            (d['Geo Biomass Other - TWh'] || 0) +
            (d['Solar Generation - TWh'] || 0) +
            (d['Wind Generation - TWh'] || 0) +
            (d['Hydro Generation - TWh'] || 0)
        );

        const ctx = document.getElementById('areaChart').getContext('2d');
        charts.areaChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [{
                    label: `Consumo de Energ칤a Renovable Moderna en ${country} (TWh)`,
                    data: renewableConsumption,
                    backgroundColor: 'rgba(75, 192, 192, 0.4)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'TWh' }
                    }
                }
            }
        });
    }
</script>

</body>
</html>